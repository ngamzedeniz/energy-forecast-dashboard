<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Forecast Results: {{ city }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .footer {
            margin-top: 50px;
            padding: 20px 0;
            border-top: 1px solid #eee;
            color: #6c757d;
            font-size: 0.85em;
            text-align: center;
        }
        .card-stat {
            background-color: #f8f9fa;
            border-left: 5px solid #0d6efd;
            border-radius: .5rem;
        }
        .insight-card {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.95em;
            background-color: #e9ecef;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5 p-4 bg-white rounded shadow-lg">
    <h1 class="mb-4 text-primary fw-bold">Dashboard: {{ city }} Energy Forecast</h1>
    
    {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        <p class="text-danger">Failed to retrieve data. Please check API permissions and server logs.</p>
    {% else %}

    <div class="row mb-5">
        <div class="col-md-4">
            <div class="card card-stat p-3 h-100">
                <h5 class="text-muted">Instant Demand Estimate</h5>
                <p class="fs-3 text-primary fw-bold">{{ predicted_demand or '-' }} <span class="text-muted fs-6">Units</span></p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-stat p-3 h-100">
                <h5 class="text-muted">Avg. Observed Temperature</h5>
                <p class="fs-3 fw-bold text-warning">{{ avg_temp or '-' }} <span class="text-muted fs-6">°C</span></p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-stat p-3 h-100">
                <h5 class="text-muted">Avg. Spot Price (EUR)</h5>
                <p class="fs-3 fw-bold text-success">{{ avg_price or '-' }} <span class="text-muted fs-6">EUR</span></p>
            </div>
        </div>
    </div>
    
    <h3 class="mb-3 text-secondary">Market & Weather Insights</h3>
    <div class="card p-3 mb-5 insight-card">
        <p class="mb-0">{{ interpretation }}</p>
    </div>

    <div class="d-flex align-items-center justify-content-between mb-3">
        <h3 class="text-secondary mb-0">Interactive Charts</h3>
        <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#modelInfoModal">
            Model Info
        </button>
    </div>

    <!-- Info Modal -->
    <div class="modal fade" id="modelInfoModal" tabindex="-1" aria-labelledby="modelInfoModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modelInfoModalLabel">Forecast Model Overview</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>
                The forecast engine integrates near-real-time weather observations with real UK energy market data.  
                Meteorological inputs are primarily sourced from the <strong>UK Met Office API</strong>.  
                When data is unavailable, it automatically switches to the <strong>Open-Meteo Archive API</strong>.  
            </p>
            <p>
                Electricity spot prices are sourced from the <strong>Elexon API</strong> for UK regions.  
                The model calculates <em>HDD/CDD indices</em> and applies a lightweight <strong>stacking regression</strong> ensemble  
                combining weather-driven and observed market patterns to estimate short-term load fluctuations.
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card mb-4 p-3">{{ demand_plot | safe }}</div>
    
    <div class="row">
        <div class="col-md-6"><div class="card mb-4 p-3">{{ weather_plot | safe }}</div></div>
        <div class="col-md-6"><div class="card mb-4 p-3">{{ market_plot | safe }}</div></div>
    </div>
    
    <h3 class="mb-3 text-secondary">Detailed Hourly Data (Forecast Region)</h3>
    <div class="table-responsive">
        <table class="table table-sm table-hover small">
            <thead class="table-primary">
            <tr>
                <th>Time (UTC)</th>
                <th>Stacking Prediction</th>
                <th>Actual Demand</th>
                <th>Temperature (°C)</th>
                <th>Wind Speed (m/s)</th>
                <th>Spot Price (EUR)</th>
                <th>Wind Generation (MW)</th>
            </tr>
            </thead>
            <tbody>
            {% for row in table_rows %}
            <tr>
                <td>{{ row.Time }}</td>
                <td>{{ row.Final_Stacking_Prediction or '-' }}</td>
                <td>{{ row.Target_Actual or '-' }}</td>
                <td>{{ row.Actual_Temp_C or '-' }}</td>
                <td>{{ row.Actual_WindSpeed or '-' }}</td>
                <td>{{ row.SpotPrice_EUR or '-' }}</td>
                <td>{{ row.WindGen_MW or '-' }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <a href="/" class="btn btn-secondary mt-3">← Run New Forecast</a>
</div>

<div class="footer">
    Developed by <strong>Gamze Deniz</strong>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
